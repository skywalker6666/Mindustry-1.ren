{"version":3,"file":"main.js","sources":["../src/json-serializer-plugin.ts"],"sourcesContent":["import {\n  Block,\n  Config,\n  ExtData,\n  FocusMode,\n  Model,\n  Topic\n} from '@blink-mind/core';\nimport { IControllerRunContext } from '@blink-mind/core/src/interfaces';\nimport debug from 'debug';\nimport { isImmutable, List, Map } from 'immutable';\n\nconst log = debug('plugin:json-serializer');\n\nexport function JsonSerializerPlugin() {\n  return {\n    serializeModel(props: IControllerRunContext, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { model, controller } = props;\n      const obj = {\n        rootTopicKey: model.rootTopicKey,\n        editorRootTopicKey: model.editorRootTopicKey,\n        focusKey: model.focusKey,\n        extData: controller.run('serializeExtData', {\n          ...props,\n          extData: model.extData\n        }),\n        topics: model.topics\n          .valueSeq()\n          .toArray()\n          .map(topic => controller.run('serializeTopic', { ...props, topic })),\n        config: controller.run('serializeConfig', {\n          ...props,\n          config: model.config\n        }),\n        formatVersion: model.formatVersion\n      };\n      return obj;\n    },\n\n    deserializeModel(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { obj, controller } = props;\n      if (obj.formatVersion == null) {\n        obj.formatVersion = '0.0';\n      }\n      const {\n        rootTopicKey,\n        editorRootTopicKey,\n        focusKey,\n        topics,\n        config,\n        extData,\n        formatVersion\n      } = obj;\n      let res = new Model();\n      res = res.merge({\n        rootTopicKey,\n        editorRootTopicKey:\n          editorRootTopicKey == null ? rootTopicKey : editorRootTopicKey,\n        focusKey,\n        extData: controller.run('deserializeExtData', {\n          ...props,\n          extData,\n          formatVersion\n        }),\n        config: controller.run('deserializeConfig', {\n          ...props,\n          config,\n          formatVersion\n        }),\n        topics: controller.run('deserializeTopics', {\n          ...props,\n          topics,\n          formatVersion\n        }),\n        formatVersion: obj.formatVersion\n      });\n      if (res.focusKey == null) {\n        res = res.set('focusKey', res.rootTopicKey);\n      }\n      if (res.focusMode == null) {\n        res = res.set('focusMode', FocusMode.NORMAL);\n      }\n      log('deserializeModel', res);\n      return res;\n    },\n\n    serializeExtData(\n      props: IControllerRunContext & { extData: ExtData },\n      next\n    ) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { extData, controller } = props;\n      const res = {};\n      extData.forEach((v, k) => {\n        res[k] = controller.run('serializeExtDataItem', {\n          props,\n          extDataKey: k,\n          extDataItem: v\n        });\n      });\n      return res;\n    },\n\n    deserializeExtData(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { extData, controller } = props;\n      let res = Map();\n      for (const extDataKey in extData) {\n        res = res.set(\n          extDataKey,\n          controller.run('deserializeExtDataItem', {\n            ...props,\n            extDataKey,\n            extDataItem: extData[extDataKey]\n          })\n        );\n      }\n      return res;\n    },\n\n    serializeExtDataItem(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { extDataItem } = props;\n      if (isImmutable(extDataItem)) {\n        return extDataItem.toJS();\n      }\n      return extDataItem;\n    },\n\n    deserializeExtDataItem(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { extDataItem } = props;\n      return extDataItem;\n    },\n\n    serializeConfig(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { config } = props;\n      return config.toJS();\n    },\n\n    deserializeConfig(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { config } = props;\n      return new Config(config);\n    },\n\n    serializeTopic(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { topic, controller } = props;\n      return {\n        key: topic.key,\n        parentKey: topic.parentKey,\n        subKeys: topic.subKeys.toArray(),\n        collapse: topic.collapse,\n        style: topic.style,\n        blocks: topic.blocks.map(block =>\n          controller.run('serializeBlock', { ...props, block })\n        )\n      };\n    },\n\n    deserializeTopic(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { topic, controller } = props;\n      const { key, parentKey, subKeys, blocks, style, collapse } = topic;\n      let res = new Topic();\n      res = res.merge({\n        key,\n        parentKey,\n        subKeys: List(subKeys),\n        style,\n        collapse,\n        blocks: controller.run('deserializeBlocks', { ...props, blocks })\n      });\n      return res;\n    },\n\n    deserializeTopics(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { topics, controller } = props;\n      let res = Map();\n      res = res.withMutations(r => {\n        topics.forEach(topic =>\n          r.set(\n            topic.key,\n            controller.run('deserializeTopic', { ...props, topic })\n          )\n        );\n      });\n      return res;\n    },\n\n    serializeBlock(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { block, controller } = props;\n      const res = {\n        type: block.type,\n        data: controller.run('serializeBlockData', { ...props })\n      };\n      return res;\n    },\n\n    serializeBlockData(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { block } = props;\n      return block.data;\n    },\n\n    deserializeBlock(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { block, controller } = props;\n      const { type } = block;\n\n      return new Block({\n        type,\n        data: controller.run('deserializeBlockData', { ...props, block })\n      });\n    },\n\n    deserializeBlockData(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { block } = props;\n      return block.data;\n    },\n\n    deserializeBlocks(props, next) {\n      const nextRes = next();\n      if (nextRes != null) return nextRes;\n      const { blocks, controller } = props;\n      let res = List();\n      res = res.withMutations(res => {\n        blocks.forEach(block =>\n          res.push(controller.run('deserializeBlock', { ...props, block }))\n        );\n      });\n      return res;\n    }\n  };\n}\n"],"names":["Model","FocusMode","Map","isImmutable","Config","Topic","List","Block"],"mappings":"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"}